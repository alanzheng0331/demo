<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜“å…¼èŒ - è´¦æˆ·è®¾ç½®</title>
    <!-- ä¿ç•™åŸç”Ÿæ ·å¼æ–‡ä»¶ï¼Œä¸ä¿®æ”¹ -->
    <link rel="stylesheet" href="style.css">
    <style>
        /* ä»…æ–°å¢é¢œè‰²è¿‡æ¸¡æ•ˆæœï¼ˆå¯é€‰ï¼Œä¸å½±å“å¸ƒå±€ï¼‰ */
        body, .navbar, .sidebar, .content-panel, .modal-container, .form-input, .btn-default, .btn-primary, .btn-danger {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        /* éªŒè¯ç é¢œè‰²é€‚é…ï¼ˆä»…é¢œè‰²ï¼‰ */
        .captcha-img {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="index.html" class="logo">
                <h1>æ˜“å…¼èŒ</h1>
            </a>
            <div class="user-info">
                <div class="avatar" onclick="openAvatarUpload()">
                    <img src="https://picsum.photos/200/200?random=1" alt="ç”¨æˆ·å¤´åƒ" onerror="this.src='https://via.placeholder.com/40/667eea/ffffff?text=å¼ '">
                </div>
                <span class="username">å¼ ä¸‰</span>
                <button class="logout-btn" onclick="logout()">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-container">
        <!-- ä¾§è¾¹æ  -->
        <aside class="sidebar">
            <div class="profile-card">
                <div class="profile-avatar" onclick="openAvatarUpload()">
                    <img src="https://picsum.photos/200/200?random=1" alt="ä¸ªäººå¤´åƒ" onerror="this.src='https://via.placeholder.com/100/667eea/ffffff?text=å¼ '">
                </div>
                <h3 class="profile-name">å¼ ä¸‰</h3>
                <p class="profile-role">å…¼èŒæ±‚èŒè€…</p>
                <!-- å·²åˆ é™¤ä¿¡ç”¨åˆ†ç›¸å…³ä»£ç  -->
                <button class="edit-profile-btn" onclick="window.location.href='personal.html'">ç¼–è¾‘èµ„æ–™</button>
            </div>

            <ul class="sidebar-nav">
                <li class="nav-item">
                    <a href="personal.html" class="nav-link" data-module="profile">
                        <span class="nav-icon">ğŸ‘¤</span>
                        <span>ä¸ªäººä¿¡æ¯</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="resume.html" class="nav-link" data-module="resume">
                        <span class="nav-icon">ğŸ“</span>
                        <span>æˆ‘çš„ç®€å†</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="apply.html" class="nav-link" data-module="apply">
                        <span class="nav-icon">ğŸ“¬</span>
                        <span>æŠ•é€’è®°å½•</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="message.html" class="nav-link" data-module="message">
                        <span class="nav-icon">ğŸ’¬</span>
                        <span>æ¶ˆæ¯ä¸­å¿ƒ</span>
                        <span class="badge">2</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="collect.html" class="nav-link" data-module="collect">
                        <span class="nav-icon">â­</span>
                        <span>æˆ‘çš„æ”¶è—</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="setting.html" class="nav-link active" data-module="setting">
                        <span class="nav-icon">âš™ï¸</span>
                        <span>è´¦æˆ·è®¾ç½®</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="help.html" class="nav-link" data-module="help">
                        <span class="nav-icon">â“</span>
                        <span>å¸®åŠ©ä¸­å¿ƒ</span>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- å³ä¾§å†…å®¹åŒº -->
        <div class="content-wrapper">
            <div class="content-panel">
                <h3 class="panel-title">è´¦æˆ·è®¾ç½®</h3>
                <div class="setting-list">
                    <div class="setting-item" onclick="openSetting('ä¿®æ”¹å¯†ç ')">
                        <div class="setting-label">
                            <span class="setting-icon">ğŸ”’</span>
                            <span>ä¿®æ”¹å¯†ç </span>
                        </div>
                        <div class="setting-action">
                            <span>å»ä¿®æ”¹</span>
                            <span>â†’</span>
                        </div>
                    </div>
                    <div class="setting-item" onclick="openSetting('ç»‘å®šæ‰‹æœºå·')">
                        <div class="setting-label">
                            <span class="setting-icon">ğŸ“</span>
                            <span>ç»‘å®šæ‰‹æœºå·</span>
                        </div>
                        <div class="setting-action">
                            <span>å·²ç»‘å®š 138****1234</span>
                            <span>â†’</span>
                        </div>
                    </div>
                    <div class="setting-item" onclick="openSetting('ç»‘å®šé‚®ç®±')">
                        <div class="setting-label">
                            <span class="setting-icon">ğŸ“§</span>
                            <span>ç»‘å®šé‚®ç®±</span>
                        </div>
                        <div class="setting-action">
                            <span>å·²ç»‘å®š zhangsan@example.com</span>
                            <span>â†’</span>
                        </div>
                    </div>
                    <div class="setting-item" onclick="openSetting('æ¶ˆæ¯é€šçŸ¥è®¾ç½®')">
                        <div class="setting-label">
                            <span class="setting-icon">ğŸ””</span>
                            <span>æ¶ˆæ¯é€šçŸ¥è®¾ç½®</span>
                        </div>
                        <div class="setting-action">
                            <span>å»è®¾ç½®</span>
                            <span>â†’</span>
                        </div>
                    </div>
                    <div class="setting-item" onclick="openSetting('è´¦å·æ³¨é”€')" style="border-bottom: none;">
                        <div class="setting-label">
                            <span class="setting-icon">ğŸ—‘ï¸</span>
                            <span>è´¦å·æ³¨é”€</span>
                        </div>
                        <div class="setting-action" style="color: var(--danger-color);">
                            <span>æ³¨é”€è´¦å·</span>
                            <span>â†’</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ¨¡æ€æ¡†å®¹å™¨ -->
    <div class="modal-mask" id="modalOverlay">
        <div class="modal-container" id="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">è®¾ç½®æ ‡é¢˜</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- åŠ¨æ€å¡«å……å†…å®¹ -->
            </div>
            <div class="modal-footer" id="modalFooter">
                <!-- åŠ¨æ€å¡«å……æŒ‰é’® -->
            </div>
        </div>
    </div>

    <!-- å¤´åƒä¸Šä¼ æ¨¡æ€æ¡† -->
    <div class="modal-mask" id="avatarModalOverlay">
        <div class="modal-container">
            <div class="modal-header">
                <h3 class="modal-title">æ›´æ¢å¤´åƒ</h3>
                <button class="modal-close" onclick="closeAvatarModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-item">
                    <label class="form-label">é€‰æ‹©å›¾ç‰‡</label>
                    <input type="file" class="form-input" accept="image/*" id="avatarInput" onchange="previewAvatar()">
                    <p class="form-tip">æ”¯æŒJPGã€PNGæ ¼å¼ï¼Œå¤§å°ä¸è¶…è¿‡2MB</p>
                </div>
                <div style="text-align: center; margin: 10px 0;">
                    <img id="avatarPreview" src="https://via.placeholder.com/100/667eea/ffffff?text=å¼ " alt="å¤´åƒé¢„è§ˆ" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover;">
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn btn-default" onclick="closeAvatarModal()">å–æ¶ˆ</button>
                <button class="modal-btn btn-primary" onclick="uploadAvatar()">ç¡®è®¤ä¸Šä¼ </button>
            </div>
        </div>
    </div>

    <!-- æç¤ºæ¶ˆæ¯ -->
    <div class="toast" id="toast"></div>

    <!-- å¼•å…¥ä¸»é¢˜æ§åˆ¶JSï¼ˆæ ¸å¿ƒï¼šä»…æ§åˆ¶é¢œè‰²ï¼‰ -->
    <script src="theme-control.js"></script>
    
    <!-- é¡µé¢åŸæœ‰JSï¼ˆä»…ä¿®æ”¹ä¸»é¢˜è®¾ç½®æäº¤é€»è¾‘ï¼‰ -->
    <script>
        // å…¨å±€å˜é‡
        const modalOverlay = document.getElementById('modalOverlay');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalFooter = document.getElementById('modalFooter');
        const toast = document.getElementById('toast');
        
        // å›¾å½¢éªŒè¯ç å…¨å±€å˜é‡
        let phoneCaptchaCode = ''; // æ‰‹æœºç»‘å®šçš„å›¾å½¢éªŒè¯ç 
        let emailCaptchaCode = ''; // é‚®ç®±ç»‘å®šçš„å›¾å½¢éªŒè¯ç 

        // åˆå§‹åŒ–ï¼šè‡ªåŠ¨åŒ¹é…ä¾§è¾¹æ æ¿€æ´»çŠ¶æ€
        window.addEventListener('DOMContentLoaded', () => {
            const currentPath = window.location.pathname.split('/').pop();
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => {
                if (link.href.includes(currentPath)) {
                    link.classList.add('active');
                } else {
                    link.classList.remove('active');
                }
            });
        });

        // ç”Ÿæˆéšæœºå›¾å½¢éªŒè¯ç ï¼ˆ4ä½å­—æ¯æ•°å­—ç»„åˆï¼‰
        function generateCaptcha() {
            const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz';
            let code = '';
            for (let i = 0; i < 4; i++) {
                code += chars[Math.floor(Math.random() * chars.length)];
            }
            return code;
        }

        // æ¸²æŸ“å›¾å½¢éªŒè¯ç ï¼ˆå¸¦å¹²æ‰°çº¹æ¨¡æ‹ŸçœŸå®éªŒè¯ç ï¼‰
        function renderCaptchaImage(containerId, code) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // ç®€å•æ¨¡æ‹Ÿå›¾å½¢éªŒè¯ç æ ·å¼ï¼ˆå®é™…é¡¹ç›®ç”¨canvasç»˜åˆ¶ï¼‰
            let captchaHtml = '';
            // æ ¹æ®å½“å‰ä¸»é¢˜é¢œè‰²é€‰æ‹©éªŒè¯ç æ–‡å­—é¢œè‰²
            const isDark = getComputedStyle(document.documentElement).getPropertyValue('--bg-main') === '#181818';
            const colors = isDark ? 
                ['#ffffff', '#7689ff', '#9c27b0', '#ff5252', '#4caf50'] : 
                ['#333', '#667eea', '#764ba2', '#f44336', '#2e7d32'];
                
            const bgColor = colors[Math.floor(Math.random() * colors.length)];
            
            // æ‹¼æ¥éªŒè¯ç å­—ç¬¦ï¼ˆåŠ å¹²æ‰°ï¼‰
            for (let i = 0; i < code.length; i++) {
                // éšæœºæ—‹è½¬è§’åº¦
                const rotate = (Math.random() - 0.5) * 20;
                captchaHtml += `<span style="display:inline-block; transform:rotate(${rotate}deg); color:${bgColor}; font-size:18px;">${code[i]}</span>`;
            }
            
            container.innerHTML = captchaHtml;
            container.style.backgroundColor = isDark ? 
                `rgba(${Math.floor(Math.random()*100)}, ${Math.floor(Math.random()*100)}, ${Math.floor(Math.random()*100)}, 0.1)` :
                `rgba(${Math.floor(Math.random()*50)}, ${Math.floor(Math.random()*50)}, ${Math.floor(Math.random()*50)}, 0.05)`;
        }

        // æ‰“å¼€è®¾ç½®é¡¹æ¨¡æ€æ¡†
        function openSetting(settingName) {
            // é‡ç½®æ¨¡æ€æ¡†å†…å®¹
            modalBody.innerHTML = '';
            modalFooter.innerHTML = '';
            modalTitle.textContent = settingName;

            switch(settingName) {
                case 'ä¿®æ”¹å¯†ç ':
                    renderChangePwdForm();
                    break;
                case 'ç»‘å®šæ‰‹æœºå·':
                    renderBindPhoneForm();
                    break;
                case 'ç»‘å®šé‚®ç®±':
                    renderBindEmailForm();
                    break;
                case 'æ¶ˆæ¯é€šçŸ¥è®¾ç½®':
                    renderNotificationForm();
                    break;
                case 'ä¸»é¢˜è®¾ç½®':
                    renderThemeForm();
                    break;
                case 'è´¦å·æ³¨é”€':
                    renderAccountDeleteForm();
                    break;
                default:
                    modalBody.innerHTML = `<p style="text-align:center; padding:20px 0;">${settingName}åŠŸèƒ½å³å°†ä¸Šçº¿ï¼Œæ•¬è¯·æœŸå¾…ï¼</p>`;
                    modalFooter.innerHTML = `<button class="modal-btn btn-primary" onclick="closeModal()">ç¡® å®š</button>`;
            }

            // æ˜¾ç¤ºæ¨¡æ€æ¡†
            modalOverlay.classList.add('active');
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            modalOverlay.classList.remove('active');
        }

        // æ˜¾ç¤ºæç¤ºæ¶ˆæ¯
        function showToast(message, type = 'info') {
            toast.textContent = message;
            toast.classList.add('active');
            
            // ä¸åŒç±»å‹çš„æç¤ºæ ·å¼ï¼ˆé€‚é…ä¸»é¢˜é¢œè‰²ï¼‰
            const isDark = getComputedStyle(document.documentElement).getPropertyValue('--bg-main') === '#181818';
            if (type === 'success') {
                toast.style.backgroundColor = 'rgba(76, 175, 80, 0.8)';
                toast.style.color = 'white';
            } else if (type === 'error') {
                toast.style.backgroundColor = 'rgba(244, 67, 54, 0.8)';
                toast.style.color = 'white';
            } else {
                toast.style.backgroundColor = isDark ? 'rgba(255,255,255,0.8)' : 'rgba(0, 0, 0, 0.8)';
                toast.style.color = isDark ? '#000' : '#fff';
            }

            setTimeout(() => {
                toast.classList.remove('active');
            }, 2000);
        }

        // 1. æ¸²æŸ“ä¿®æ”¹å¯†ç è¡¨å•
        function renderChangePwdForm() {
            modalBody.innerHTML = `
                <div class="form-item">
                    <label class="form-label">åŸå¯†ç </label>
                    <input type="password" class="form-input" id="oldPwd" placeholder="è¯·è¾“å…¥åŸå¯†ç ">
                </div>
                <div class="form-item">
                    <label class="form-label">æ–°å¯†ç </label>
                    <input type="password" class="form-input" id="newPwd" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆ6-20ä½ï¼‰">
                </div>
                <div class="form-item">
                    <label class="form-label">ç¡®è®¤æ–°å¯†ç </label>
                    <input type="password" class="form-input" id="confirmPwd" placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç ">
                </div>
            `;

            modalFooter.innerHTML = `
                <button class="modal-btn btn-default" onclick="closeModal()">å– æ¶ˆ</button>
                <button class="modal-btn btn-primary" onclick="submitChangePwd()">ä¿ å­˜</button>
            `;
        }

        // æäº¤ä¿®æ”¹å¯†ç 
        function submitChangePwd() {
            const oldPwd = document.getElementById('oldPwd').value;
            const newPwd = document.getElementById('newPwd').value;
            const confirmPwd = document.getElementById('confirmPwd').value;

            if (!oldPwd) {
                showToast('è¯·è¾“å…¥åŸå¯†ç ', 'error');
                return;
            }

            if (newPwd.length < 6 || newPwd.length > 20) {
                showToast('æ–°å¯†ç é•¿åº¦å¿…é¡»åœ¨6-20ä½ä¹‹é—´', 'error');
                return;
            }

            if (newPwd !== confirmPwd) {
                showToast('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´', 'error');
                return;
            }

            // æ¨¡æ‹Ÿæäº¤æˆåŠŸ
            showToast('å¯†ç ä¿®æ”¹æˆåŠŸ', 'success');
            setTimeout(closeModal, 1500);
        }

        // 2. æ¸²æŸ“ç»‘å®šæ‰‹æœºå·è¡¨å•ï¼ˆæ”¹ä¸ºå›¾å½¢éªŒè¯ç ï¼‰
        function renderBindPhoneForm() {
            // ç”Ÿæˆæ–°çš„å›¾å½¢éªŒè¯ç 
            phoneCaptchaCode = generateCaptcha();
            
            modalBody.innerHTML = `
                <div class="form-item">
                    <label class="form-label">å½“å‰æ‰‹æœºå·</label>
                    <input type="text" class="form-input" value="138****1234" disabled>
                </div>
                <div class="form-item">
                    <label class="form-label">æ–°æ‰‹æœºå·</label>
                    <input type="text" class="form-input" id="newPhone" placeholder="è¯·è¾“å…¥æ–°æ‰‹æœºå·">
                </div>
                <div class="form-item">
                    <label class="form-label">å›¾å½¢éªŒè¯ç </label>
                    <div class="captcha-container">
                        <input type="text" class="form-input" id="phoneCaptcha" placeholder="è¯·è¾“å…¥4ä½éªŒè¯ç ï¼ˆä¸åˆ†å¤§å°å†™ï¼‰">
                        <div class="captcha-img" id="phoneCaptchaImg" onclick="refreshPhoneCaptcha()">åŠ è½½ä¸­...</div>
                    </div>
                    <p class="form-tip" style="font-size:12px; margin-top:5px;">ç‚¹å‡»éªŒè¯ç å›¾ç‰‡å¯åˆ·æ–°</p>
                </div>
            `;

            modalFooter.innerHTML = `
                <button class="modal-btn btn-default" onclick="closeModal()">å– æ¶ˆ</button>
                <button class="modal-btn btn-primary" onclick="submitBindPhone()">ä¿ å­˜</button>
            `;

            // æ¸²æŸ“å›¾å½¢éªŒè¯ç å›¾ç‰‡
            setTimeout(() => {
                renderCaptchaImage('phoneCaptchaImg', phoneCaptchaCode);
            }, 100);
        }

        // åˆ·æ–°æ‰‹æœºå›¾å½¢éªŒè¯ç 
        function refreshPhoneCaptcha() {
            phoneCaptchaCode = generateCaptcha();
            renderCaptchaImage('phoneCaptchaImg', phoneCaptchaCode);
        }

        // æäº¤ç»‘å®šæ‰‹æœºå·ï¼ˆéªŒè¯å›¾å½¢éªŒè¯ç ï¼‰
        function submitBindPhone() {
            const newPhone = document.getElementById('newPhone').value;
            const inputCaptcha = document.getElementById('phoneCaptcha').value.trim();
            const phoneReg = /^1[3-9]\d{9}$/;

            if (!phoneReg.test(newPhone)) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„æ‰‹æœºå·', 'error');
                return;
            }

            if (!inputCaptcha) {
                showToast('è¯·è¾“å…¥å›¾å½¢éªŒè¯ç ', 'error');
                return;
            }

            // éªŒè¯å›¾å½¢éªŒè¯ç ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
            if (inputCaptcha.toUpperCase() !== phoneCaptchaCode.toUpperCase()) {
                showToast('å›¾å½¢éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥', 'error');
                // åˆ·æ–°éªŒè¯ç 
                refreshPhoneCaptcha();
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('phoneCaptcha').value = '';
                return;
            }

            // æ¨¡æ‹Ÿæäº¤æˆåŠŸ
            showToast('æ‰‹æœºå·ä¿®æ”¹æˆåŠŸ', 'success');
            setTimeout(() => {
                closeModal();
                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                document.querySelector('.setting-item:nth-child(2) .setting-action span:first-child').textContent = `å·²ç»‘å®š ${newPhone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2')}`;
            }, 1500);
        }

        // 3. æ¸²æŸ“ç»‘å®šé‚®ç®±è¡¨å•ï¼ˆæ”¹ä¸ºå›¾å½¢éªŒè¯ç ï¼‰
        function renderBindEmailForm() {
            // ç”Ÿæˆæ–°çš„å›¾å½¢éªŒè¯ç 
            emailCaptchaCode = generateCaptcha();
            
            modalBody.innerHTML = `
                <div class="form-item">
                    <label class="form-label">å½“å‰é‚®ç®±</label>
                    <input type="email" class="form-input" value="zhangsan@example.com" disabled>
                </div>
                <div class="form-item">
                    <label class="form-label">æ–°é‚®ç®±</label>
                    <input type="email" class="form-input" id="newEmail" placeholder="è¯·è¾“å…¥æ–°é‚®ç®±">
                </div>
                <div class="form-item">
                    <label class="form-label">å›¾å½¢éªŒè¯ç </label>
                    <div class="captcha-container">
                        <input type="text" class="form-input" id="emailCaptcha" placeholder="è¯·è¾“å…¥4ä½éªŒè¯ç ï¼ˆä¸åˆ†å¤§å°å†™ï¼‰">
                        <div class="captcha-img" id="emailCaptchaImg" onclick="refreshEmailCaptcha()">åŠ è½½ä¸­...</div>
                    </div>
                    <p class="form-tip" style="font-size:12px; margin-top:5px;">ç‚¹å‡»éªŒè¯ç å›¾ç‰‡å¯åˆ·æ–°</p>
                </div>
            `;

            modalFooter.innerHTML = `
                <button class="modal-btn btn-default" onclick="closeModal()">å– æ¶ˆ</button>
                <button class="modal-btn btn-primary" onclick="submitBindEmail()">ä¿ å­˜</button>
            `;

            // æ¸²æŸ“å›¾å½¢éªŒè¯ç å›¾ç‰‡
            setTimeout(() => {
                renderCaptchaImage('emailCaptchaImg', emailCaptchaCode);
            }, 100);
        }

        // åˆ·æ–°é‚®ç®±å›¾å½¢éªŒè¯ç 
        function refreshEmailCaptcha() {
            emailCaptchaCode = generateCaptcha();
            renderCaptchaImage('emailCaptchaImg', emailCaptchaCode);
        }

        // æäº¤ç»‘å®šé‚®ç®±ï¼ˆéªŒè¯å›¾å½¢éªŒè¯ç ï¼‰
        function submitBindEmail() {
            const newEmail = document.getElementById('newEmail').value;
            const inputCaptcha = document.getElementById('emailCaptcha').value.trim();
            const emailReg = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;

            if (!emailReg.test(newEmail)) {
                showToast('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€', 'error');
                return;
            }

            if (!inputCaptcha) {
                showToast('è¯·è¾“å…¥å›¾å½¢éªŒè¯ç ', 'error');
                return;
            }

            // éªŒè¯å›¾å½¢éªŒè¯ç ï¼ˆå¿½ç•¥å¤§å°å†™ï¼‰
            if (inputCaptcha.toUpperCase() !== emailCaptchaCode.toUpperCase()) {
                showToast('å›¾å½¢éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡æ–°è¾“å…¥', 'error');
                // åˆ·æ–°éªŒè¯ç 
                refreshEmailCaptcha();
                // æ¸…ç©ºè¾“å…¥æ¡†
                document.getElementById('emailCaptcha').value = '';
                return;
            }

            // æ¨¡æ‹Ÿæäº¤æˆåŠŸ
            showToast('é‚®ç®±ä¿®æ”¹æˆåŠŸ', 'success');
            setTimeout(() => {
                closeModal();
                // æ›´æ–°é¡µé¢æ˜¾ç¤º
                document.querySelector('.setting-item:nth-child(3) .setting-action span:first-child').textContent = `å·²ç»‘å®š ${newEmail}`;
            }, 1500);
        }

        // 4. æ¸²æŸ“æ¶ˆæ¯é€šçŸ¥è®¾ç½®è¡¨å•
        function renderNotificationForm() {
            // ä»æœ¬åœ°å­˜å‚¨è¯»å–é€šçŸ¥è®¾ç½®ï¼Œæ²¡æœ‰åˆ™é»˜è®¤å¼€å¯
            const notificationSettings = JSON.parse(localStorage.getItem('notificationSettings')) || {
                delivery: true,  // æŠ•é€’è¿›åº¦
                system: true,    // ç³»ç»Ÿé€šçŸ¥
                recommend: false // å…¼èŒæ¨è
            };

            modalBody.innerHTML = `
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="deliveryNotify" ${notificationSettings.delivery ? 'checked' : ''}>
                    <label class="form-check-label" for="deliveryNotify">æŠ•é€’è¿›åº¦é€šçŸ¥</label>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="systemNotify" ${notificationSettings.system ? 'checked' : ''}>
                    <label class="form-check-label" for="systemNotify">ç³»ç»Ÿé€šçŸ¥</label>
                </div>
                <div class="form-check">
                    <input type="checkbox" class="form-check-input" id="recommendNotify" ${notificationSettings.recommend ? 'checked' : ''}>
                    <label class="form-check-label" for="recommendNotify">å…¼èŒæ¨èé€šçŸ¥</label>
                </div>
            `;

            modalFooter.innerHTML = `
                <button class="modal-btn btn-default" onclick="closeModal()">å– æ¶ˆ</button>
                <button class="modal-btn btn-primary" onclick="submitNotificationSettings()">ä¿ å­˜</button>
            `;
        }

        // æäº¤é€šçŸ¥è®¾ç½®
        function submitNotificationSettings() {
            const delivery = document.getElementById('deliveryNotify').checked;
            const system = document.getElementById('systemNotify').checked;
            const recommend = document.getElementById('recommendNotify').checked;

            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            const settings = { delivery, system, recommend };
            localStorage.setItem('notificationSettings', JSON.stringify(settings));

            showToast('é€šçŸ¥è®¾ç½®ä¿å­˜æˆåŠŸ', 'success');
            setTimeout(() => {
                closeModal();
            }, 1000);
        }

        // 5. æ¸²æŸ“ä¸»é¢˜è®¾ç½®è¡¨å•
        function renderThemeForm() {
            const savedTheme = ThemeController.getCurrent() || 'light';

            modalBody.innerHTML = `
                <div class="form-check">
                    <input type="radio" class="form-check-input" name="theme" id="lightTheme" ${savedTheme === 'light' ? 'checked' : ''}>
                    <label class="form-check-label" for="lightTheme">æµ…è‰²æ¨¡å¼</label>
                </div>
                <div class="form-check">
                    <input type="radio" class="form-check-input" name="theme" id="darkTheme" ${savedTheme === 'dark' ? 'checked' : ''}>
                    <label class="form-check-label" for="darkTheme">æ·±è‰²æ¨¡å¼</label>
                </div>
                <div class="form-check">
                    <input type="radio" class="form-check-input" name="theme" id="autoTheme" ${savedTheme === 'auto' ? 'checked' : ''}>
                    <label class="form-check-label" for="autoTheme">è·Ÿéšç³»ç»Ÿ</label>
                </div>
            `;

            modalFooter.innerHTML = `
                <button class="modal-btn btn-default" onclick="closeModal()">å– æ¶ˆ</button>
                <button class="modal-btn btn-primary" onclick="submitThemeSettings()">ä¿ å­˜</button>
            `;
        }

        // æäº¤ä¸»é¢˜è®¾ç½®ï¼ˆæ ¸å¿ƒä¿®æ”¹ï¼šè°ƒç”¨ThemeControllerï¼‰
        function submitThemeSettings() {
            let selectedTheme;
            if (document.getElementById('lightTheme').checked) {
                selectedTheme = 'light';
            } else if (document.getElementById('darkTheme').checked) {
                selectedTheme = 'dark';
            } else {
                selectedTheme = 'auto';
            }

            // è°ƒç”¨å…¨å±€ä¸»é¢˜æ§åˆ¶å™¨åº”ç”¨é¢œè‰²
            ThemeController.apply(selectedTheme);
            showToast('ä¸»é¢˜è®¾ç½®å·²ä¿å­˜', 'success');
            setTimeout(closeModal, 1000);
        }

        // 6. æ¸²æŸ“è´¦å·æ³¨é”€è¡¨å•
        function renderAccountDeleteForm() {
            modalBody.innerHTML = `
                <div style="padding: 20px 0; text-align: center;">
                    <div style="font-size: 48px; color: var(--danger-color); margin-bottom: 15px;">âš ï¸</div>
                    <p style="margin-bottom: 10px; font-size: 16px;">ç¡®å®šè¦æ³¨é”€è´¦å·å—ï¼Ÿ</p>
                    <p style="color: var(--light-text); font-size: 14px; line-height: 1.6;">
                        è´¦å·æ³¨é”€åï¼Œæ‰€æœ‰æ•°æ®å°†æ— æ³•æ¢å¤ï¼ŒåŒ…æ‹¬ä½†ä¸é™äº<br>
                        ä¸ªäººä¿¡æ¯ã€æŠ•é€’è®°å½•ã€æ”¶è—èŒä½ç­‰
                    </p>
                </div>
                <div class="form-item">
                    <label class="form-label">è¯·è¾“å…¥å¯†ç ç¡®è®¤</label>
                    <input type="password" class="form-input" id="deletePwd" placeholder="è¾“å…¥å¯†ç ç¡®è®¤æ³¨é”€">
                </div>
            `;

            modalFooter.innerHTML = `
                <button class="modal-btn btn-default" onclick="closeModal()">å– æ¶ˆ</button>
                <button class="modal-btn btn-danger" onclick="submitAccountDelete()">ç¡®è®¤æ³¨é”€</button>
            `;
        }

        // æäº¤è´¦å·æ³¨é”€
        function submitAccountDelete() {
            const deletePwd = document.getElementById('deletePwd').value;

            if (!deletePwd) {
                showToast('è¯·è¾“å…¥å¯†ç ç¡®è®¤', 'error');
                return;
            }

            // æ¨¡æ‹Ÿæ³¨é”€æˆåŠŸ
            showToast('è´¦å·æ³¨é”€æˆåŠŸ', 'success');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 1500);
        }

        // å¤´åƒä¸Šä¼ ç›¸å…³
        function openAvatarUpload() {
            document.getElementById('avatarModalOverlay').classList.add('active');
        }

        function closeAvatarModal() {
            document.getElementById('avatarModalOverlay').classList.remove('active');
        }

        function previewAvatar() {
            const file = document.getElementById('avatarInput').files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹å’Œå¤§å°
            const isImage = file.type.startsWith('image/');
            const isLt2M = file.size / 1024 / 1024 < 2;

            if (!isImage) {
                showToast('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                return;
            }

            if (!isLt2M) {
                showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB', 'error');
                return;
            }

            // é¢„è§ˆå›¾ç‰‡
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('avatarPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function uploadAvatar() {
            const file = document.getElementById('avatarInput').files[0];
            if (!file) {
                showToast('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„å¤´åƒ', 'error');
                return;
            }

            // æ¨¡æ‹Ÿä¸Šä¼ æˆåŠŸ
            showToast('å¤´åƒä¸Šä¼ æˆåŠŸ', 'success');
            setTimeout(() => {
                closeAvatarModal();
                // æ›´æ–°é¡µé¢ä¸Šçš„å¤´åƒ
                const avatarElements = document.querySelectorAll('.avatar img, .profile-avatar img');
                avatarElements.forEach(img => {
                    img.src = document.getElementById('avatarPreview').src;
                });
            }, 1000);
        }

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                closeModal();
            }
        });

        document.getElementById('avatarModalOverlay').addEventListener('click', (e) => {
            if (e.target === document.getElementById('avatarModalOverlay')) {
                closeAvatarModal();
            }
        });

        // é”®ç›˜ESCå…³é—­æ¨¡æ€æ¡†
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                closeAvatarModal();
            }
        });

        // é€€å‡ºç™»å½•
        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                showToast('é€€å‡ºç™»å½•æˆåŠŸ', 'success');
                setTimeout(() => {
                    window.location.href = 'login.html';
                }, 1000);
            }
        }
    </script>
</body>
</html>